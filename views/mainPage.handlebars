<html>
<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	
	<link href="css/bootstrap.css" rel="stylesheet">
	<link href="css/bootstrap-theme.css" rel="stylesheet">

	<link href="css/navbar.css" rel="stylesheet">
  <link href="css/main.css" rel="stylesheet">
  <link href="css/searchbar.css" rel="stylesheet">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.0.13/css/all.css" integrity="sha384-DNOHZ68U8hZfKXOrtjWvjxusGo9WQnrNx2sqG0tfsghAvtVlRW3tvkXWZh58N9jp" crossorigin="anonymous">


 
  <script src="https://www.gstatic.com/firebasejs/5.0.3/firebase.js"></script>
  <script>
  // Initialize Firebase
  
</script>

  <script src="https://code.jquery.com/jquery.js"></script>
  <script src="/js/bootstrap.js"></script>


  <script type="text/javascript">
    // Firebase
    var config = {
     apiKey: "AIzaSyD3LN58BAvOG8ouHInfEzCKYmbwZI06gec",
     authDomain: "musaic-1c1c3.firebaseapp.com",
     databaseURL: "https://musaic-1c1c3.firebaseio.com",
     projectId: "musaic-1c1c3",
     storageBucket: "musaic-1c1c3.appspot.com",
     messagingSenderId: "287286942286"
    };
    firebase.initializeApp(config);

    const database = firebase.database();

    const key = 'users/'; // Gets all users

   database.ref(key).once('value', (snapshot) => {
    const users = snapshot.val();

  $(document).ready(()=>{
   
    console.log(users);
    console.log(users.topSong);

    const toAdd = document.createDocumentFragment();
    let index = 0;

    if (users) {
      //Loops through all users
      Object.keys(users).forEach((name) => {
        const newLi = document.createElement('div');

        let userName = 'userName' + index;
        let songName = 'songName' + index;
        let artistName = 'artistName' + index;
        let pic = 'pic' + index;
        let chatText = 'chatText' + index;
        let clockText = 'clockText' + index;
        let transparentBoxColor = 'transparentBoxColor' + index;
        

        //Template for Square Boxes
        // <a href='/profile'> reimplement </a> reimplement by wrapping around image
        newLi.innerHTML = "<div class='col-sm-4 grow profile profileBeg' id='profile'"+index+"><h3 class='userNameText profileText' id='"+userName+"'></h3><h4 class='songNameText profileText' id='"+songName+"' ></h4><h4 class='artistNameText profileText' id='"+artistName+"'></h4><div class='transparentBox' id='"+transparentBoxColor+"'></div><img class='profilePic col-sm-2' id='"+pic+"'><img class='icon chatBubble' src='css/Icons/chatBubble.png'><h5 class='chatNumber' id='"+chatText+"'></h5><img class='icon clock' src='css/Icons/clock.png'><h5 class='clockNumber' id='"+clockText+"'></h5></div></div>";

        toAdd.appendChild(newLi);
        index = index +1;

        console.log(users[name].topSong);
      });

      // Adds all the squares into the HTML
      document.getElementById('allProfiles').appendChild(toAdd); 

      index = 0; //reset index

      // Gets info from the database to fill in the newly created squares
      Object.keys(users).forEach((name) => {

        //Color changer
        if (index % 2 === 1) {
          $('#transparentBoxColor' + index).css("background-color", "#FF4365");
        }

        $('#userName' + index).html(users[name].displayName);
        $('#songName' + index).html(users[name].topSong);

        if(users[name].topSongPrev){
          $('#songName' + index).attr("data-prev_url", users[name].topSongPrev);
          $('#songName' + index).attr("data-songName", users[name].topSong);
          $('#songName' + index).attr("data-topSongArtist", users[name].topSongArtist);
          console.log("SONG PREVIEW ADDED");
          console.log($('#songName' + index).attr("data-prev_url"));
        }

        $('#artistName' + index).html(users[name].topSongArtist);
        if (users[name].image) {
          $('#pic' + index).attr('src', users[name].image);
        }

        else {
          $('#pic' + index).attr('src', 'css/ProfilePics/userDefault.png');
        }
        //$('#chatText' + index).html(e.chat);
        //$('#clockText' + index).html(e.time);
        index = index + 1;
      });
    }

   });
      
        $('.userNameText').click(() => {
          console.log("Hi");
        });

        //Overflow check
        $('.songNameText').hover(() => {
        /*  console.log($(this).attr('id'));
          //$('.songNameText').css("background-color", "#4388ff");

          console.log("hover");
          console.log(document.getElementsByClassName('songNameText')[0].scrollWidth);
          console.log(document.getElementsByClassName('songNameText')[0].offsetWidth);

          console.log(document.getElementsByClassName('transparentBox')[0].offsetWidth); */
        });

        let playingCssClass = 'playing';
        let audioObject = null;
        var playing = false;
        $('.songNameText').click((e) => {



          var target = e.target;
          console.log(target);
          console.log("Song Name Clicked");
          console.log("ID: "+target.id);
          console.log(target.innerHTML);
          console.log("Preview URL = "+target.getAttribute('data-prev_url')); 




          if (target.classList.contains(playingCssClass)) {
              audioObject.pause();
              playing=false;
          } else {
              if (audioObject) {
                  audioObject.pause();
                  playing = false
              }

          audioObject = new Audio(target.getAttribute('data-prev_url'));
          audioObject.play();
          $("#play-btn").html("<i class='far fa-pause-circle'></i>");
          playing = true;

          target.classList.add(playingCssClass);

          console.log(target.getAttribute('data-songName'));
          console.log(target.getAttribute('data-topSongArtist'));

          $("#songTitle" ).html(target.getAttribute('data-songName'));
          $("#songArtist").html(target.getAttribute('data-topSongArtist'));


          audioObject.addEventListener('ended', function () {
              target.classList.remove(playingCssClass);
              playing = false;
          });
          audioObject.addEventListener('pause', function () {
               target.classList.remove(playingCssClass);
               playing = false;
          });


        }
      });

        $("#play-btn").click(() =>{

          if(playing == false){
              audioObject.play();
              $("#play-btn").html("<i class='far fa-pause-circle'></i>");
              playing = true;
            }else{
              audioObject.pause();
              $("#play-btn").html("<i class='far fa-play-circle'></i>");
              playing = false;
            }
        })
        

    }); 
  </script>
</head>

<body>


  <!-- Hamburger Menu -->
	<nav role="navigation">
		<div id="menuToggle">
   	 		<!-- A fake / hidden checkbox is used as click reciever, so you can use the :checked selector on it.-->
 	   		
 	   		<input type="checkbox" />
    
 	   		<!--Some spans to act as a hamburger.-->
  	  		<span></span>
  	  		<span></span>
  	  		<span></span>
   	  		<ul id="menu">
   	   			<a href="#" id="active"><li>Home</li></a>
   	   			<a href="community"><li>Community</li></a>
  	    		<!-- <a href="myProfile"><li>My Profile</li></a> -->
  	    		<!-- <a href="#"><li>Settings</li></a> -->
            <a href="/"><li>Sign Out</li></a>
   			</ul>
  		</div>
	</nav>

    <h1 class="text-center">Musaic</h1>

    <h3 class="text-center">Music Tastes</h3>

    <h2 class="text-center underline">Top Songs</h2>

    <!-- Div that holds all the profiles in the beginning -->
    <div class="container-fluid" id="allProfiles">
      <div class="profileBeg row">
      </div>
    </div>


  <div class="navbar">
    <a href="#" id="play-btn"><i class="far fa-play-circle"></i></a>
    <p id="songTitle"> song title </p>
    <p id="songArtist"> Artist </p>
  </div>

</body>
</html>
